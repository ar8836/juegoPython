
"""
GLFW (OpenGL 3.3 Compatibility) y Pygame (Sonido).
Reproduce música de fondo continua y un efecto de sonido al presionar ESPACIO.

Rutas de sonido:
- Efecto (disparo): ~/Programacion/Python/juegoPython/sounds/disparo1.mp3
- Ambiente (musica): ~/Programacion/Python/juegoPython/sounds/ambiente.mp3
"""

import glfw
from OpenGL.GL import *
import pygame
import os

# --- Configuración de Archivos y Directorios ---
DIRECTORIO_BASE = os.path.dirname(os.path.abspath(__file__))

# Rutas para el efecto de sonido y la música de ambiente
RUTA_EFECTO = "/home/ariel/Programacion/Python/juegoPython/sounds/disparo1.mp3"
RUTA_AMBIENTE = "/home/ariel/Programacion/Python/juegoPython/sounds/ambiente1.mp3"

# Variables globales para el sonido
sonido_disparo = None
# La música se maneja con pygame.mixer.music, no necesita una variable global de Sound object.


def inicializar_pygame_sonido():
    """
    Inicializa el módulo de mezclador de Pygame, carga el efecto de sonido (Sound) 
    y carga/reproduce la música de ambiente (mixer.music).
    """
    global sonido_disparo
    try:
        # Inicializar Pygame Mixer (esencial para ambos tipos de audio)
        pygame.mixer.init(44100, -16, 2, 2048)
        
        # --- 1. CARGA DEL EFECTO DE SONIDO (gestionado por Sound/Canales) ---
        print(f"Buscando efecto de sonido en: {RUTA_EFECTO}")
        if not os.path.exists(RUTA_EFECTO):
            print(f"ERROR: Efecto de sonido no encontrado en: {RUTA_EFECTO}")
            return
        sonido_disparo = pygame.mixer.Sound(RUTA_EFECTO)
        
        # --- 2. CARGA Y REPRODUCCIÓN DE MÚSICA DE AMBIENTE (gestionado por mixer.music) ---
        print(f"Buscando música de ambiente en: {RUTA_AMBIENTE}")
        if not os.path.exists(RUTA_AMBIENTE):
            print(f"ERROR: Música de ambiente no encontrada en: {RUTA_AMBIENTE}")
        else:
            # Cargar la música
            pygame.mixer.music.load(RUTA_AMBIENTE)
            # Reproducir la música en bucle infinito (-1)
            pygame.mixer.music.play(-1)
            print("Música de ambiente iniciada en bucle.")
            
        print("Módulo de sonido de Pygame inicializado y sonidos cargados.")
        
    except pygame.error as e:
        print(f"Error al inicializar Pygame Mixer o cargar el sonido: {e}")
        print("Verifica el archivo de sonido y la instalación de Pygame/SDL.")


def iniciar_ventana():
    """
    Inicializa una ventana GLFW/OpenGL solicitando el Perfil de Compatibilidad 3.3.
    Esto permite usar glBegin/glEnd en sistemas modernos.
    :return: La ventana GLFW.
    """
    if not glfw.init():
        raise Exception("No se pudo iniciar GLFW")
    
    # Solicitamos OpenGL 3.3 y Perfil de Compatibilidad para glBegin/glEnd.
    glfw.window_hint(glfw.CONTEXT_VERSION_MAJOR, 3)
    glfw.window_hint(glfw.CONTEXT_VERSION_MINOR, 3)
    glfw.window_hint(glfw.OPENGL_PROFILE, glfw.OPENGL_COMPAT_PROFILE)
    
    ventana = glfw.create_window(800, 600, "OpenGL 3.3 Compatibility + Música y Efecto de Sonido", None, None)
    
    if not ventana:
        glfw.terminate()
        raise Exception("No se pudo crear la ventana GLFW")
        
    glfw.make_context_current(ventana)
    return ventana


def key_callback(window, key, scancode, action, mods):
    """
    Función de callback de teclado que reproduce el efecto de sonido al presionar ESPACIO.
    """
    global sonido_disparo
    
    # Solo procesamos eventos cuando la tecla es PRESIONADA o REPETIDA
    if action == glfw.PRESS or action == glfw.REPEAT:
        
        if key == glfw.KEY_SPACE:
            print("Tecla ESPACIO presionada. Reproduciendo efecto de sonido...")
            
            if sonido_disparo:
                # Reproducir el sonido. Como es un objeto Sound, usa un canal 
                # separado y NO interrumpe la música.
                sonido_disparo.play()
            else:
                print("Advertencia: El sonido no pudo ser cargado o inicializado.")

        elif key == glfw.KEY_ESCAPE:
            print("Escape presionado - Cerrando ventana")
            glfw.set_window_should_close(window, True)
            

def dibujar_escena():
    """
    Función de dibujo de la escena de OpenGL. Utiliza glBegin/glEnd.
    """
    # Establecer el color de fondo (negro)
    glClearColor(0.0, 0.0, 0.0, 1.0)
    glClear(GL_COLOR_BUFFER_BIT)
    
    # Dibujar un cuadrado blanco simple en el centro usando la pipeline de función fija
    glBegin(GL_QUADS)
    glColor3f(1.0, 1.0, 1.0)
    glVertex2f(-0.2, 0.2)
    glVertex2f( 0.2, 0.2)
    glVertex2f( 0.2, -0.2)
    glVertex2f(-0.2, -0.2)
    glEnd()


def programa_principal():
    
    # 1. Inicializar Pygame Mixer y cargar los sonidos
    inicializar_pygame_sonido()
    
    # 2. Inicializar GLFW y crear la ventana
    try:
        ventana = iniciar_ventana()
    except Exception as e:
        print(f"Error fatal al iniciar la ventana: {e}")
        # Detener Pygame si la ventana falla
        pygame.mixer.quit()
        return

    # 3. Registrar la función de callback de teclado
    glfw.set_key_callback(ventana, key_callback)
    
    # Bucle principal de renderizado
    while not glfw.window_should_close(ventana):
        
        # Dibujar la escena
        dibujar_escena()
        
        # Intercambiar búferes para mostrar el resultado
        glfw.swap_buffers(ventana)
        
        # Procesar eventos (teclado, ratón, etc.)
        glfw.poll_events()
        
    # 4. Terminar: Detener la música, terminar Pygame Mixer y GLFW
    pygame.mixer.music.stop() # <-- NUEVO
    pygame.mixer.quit()
    glfw.terminate()


# Llamado al programa principal de control
if __name__ == "__main__":
    programa_principal()Programa que combina GLFW (para la ventana/OpenGL) y Pygame (para el sonido).
Muestra una ventana y reproduce un sonido al presionar la tecla ESPACIO.

Ruta esperada del sonido:
~/Programacion/Python/juegoPython/sounds/disparo.wav
"""

import glfw
from OpenGL.GL import *
import pygame
import os

# --- Configuración de Archivos y Directorios ---
# Obtener la ruta del directorio actual del script para construir la ruta del sonido.
# NOTA: En un entorno real, es mejor usar rutas absolutas o relativas al script principal.
# DIRECTORIO_BASE = os.path.dirname(os.path.abspath(__file__))
# Si el script se ejecuta directamente desde el directorio:
# ~/Programacion/Python/juegoPython/
# La ruta del sonido será:
# RUTA_SONIDO = "/home/ariel/Programacion/Python/juegoPython/sounds/disparo1.mp3"
# Si el script estuviera, por ejemplo, en 'src/', ajústalo:
# RUTA_SONIDO = os.path.join(DIRECTORIO_BASE, '..', 'sounds', 'disparo.wav')
# Para este ejemplo, asumiremos que el script está al mismo nivel que la carpeta 'sounds'.

RUTA_SONIDO = "/home/ariel/Programacion/Python/juegoPython/sounds/disparo1.mp3"

# Variable global para almacenar el objeto de sonido de Pygame
sonido_disparo = None


def inicializar_pygame_sonido():
    """
    Inicializa el módulo de mezclador de Pygame y carga el efecto de sonido.
    """
    global sonido_disparo
    try:
        # Inicializar solo el módulo de mezclador (mixer) de Pygame
        pygame.mixer.init() 
        print(f"Buscando sonido en: {RUTA_SONIDO}")
        
        # Cargar el sonido
        if not os.path.exists(RUTA_SONIDO):
            print(f"ERROR: Archivo de sonido no encontrado en la ruta: {RUTA_SONIDO}")
            print("Asegúrate de que 'disparo.wav' esté en la carpeta 'sounds'.")
            return
            
        sonido_disparo = pygame.mixer.Sound(RUTA_SONIDO)
        print("Módulo de sonido de Pygame inicializado y sonido cargado.")
        

